name: Build & Deploy
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  code-quality:
    name: "ğŸ‘€ Code Quality"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]

    steps:
      - name: ğŸ”½ Download project
        uses: actions/checkout@v2
        with:
          persist-credential: false

      - name: ğŸ  Install Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ‘·â€â™‚ï¸ Install dependencies
        run: |
          npm i

      - name: ğŸ”… Syntaxis standard prettier
        run: |
          echo "Recuerda tener instalado Prettier como formateador de cÃ³digo en tu Editor de texto"
          echo "Este cÃ³digo usarÃ¡ como estÃ¡ndar la indentaciÃ³n de Prettier."
          echo "Para solucionar tu indentaciÃ³n, ejecuta npm run syntax:fix"
          npm run syntax:test

      - name: ğŸ‘€ Code quality
        run: |
          echo "Se revisarÃ¡ la calidad del cÃ³digo para que la consola no tenga warnings ni errores."
          echo "Se validarÃ¡ que no existan variables sin usar, console.logs, malos estÃ¡ndares de cÃ³digo, etc."
          npm run lint

      - name: ğŸ‘€ Project standards
        run: |
          npm test -- estandar.test.js

      - name: ğŸ§ª Tests
        env:
          MONGO_BD: ${{ secrets.MONGO_BD }}
        run: |
          echo $MONGO_BD
          echo '{ "mongopath": "${{ secrets.MONGO_BD }}"}' > credentials.json
          npm test -- connections.test.js --forceExit

  generate-docs:
    needs: code-quality
    name: "ğŸ“ƒ Generate docs"
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]

    steps:
      - name: ğŸ”½ Download project
        uses: actions/checkout@v2
        with:
          persist-credential: false

      - name: ğŸ  Install Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ‘·â€â™‚ï¸ Install dependencies
        run: |
          npm i

      - name: ğŸ‘·ğŸ“ƒ Generate documentation
        run: |
          npm run generate-docs

      - name: ğŸ“„ Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          branch: master-docs
          base: master
          delete-branch: true
          commit-message: New documentation generated
          title: New documentation generated
          body: |
            Se ha detectado nuevos cambios en la documentaciÃ³n del archivo. 
            Por lo que se ha generado una nueva documentaciÃ³n.
          labels: documentation
          reviewers: rmaafs

      - name: ğŸš€ Deploy docs
        uses: JamesIves/github-pages-deploy-action@3.5.9
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: "true"
        with:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH: gh-pages-docs
          FOLDER: docs
